<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Unik Rastreia">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>Rastreamento & Gest√£o</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --navy-dark: #0f172a;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray: #64748b;
            --white: #ffffff;
            --blue-bright: #2563eb;
        }

        /* Reset e Base */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: #e2e8f0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            width: auto;
            z-index: 1000;
            padding: 16px 20px;
            padding-top: max(16px, env(safe-area-inset-top));
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.6) 0%, rgba(0, 0, 0, 0) 100%);
        }

        .btn-back,
        .btn-action {
            pointer-events: auto;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--navy-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-back:active,
        .btn-action:active {
            transform: scale(0.95);
        }

        .action-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }

        /* MAPA */
        #map {
            flex: 1;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* MAP ADDRESS FLOATING PILL */
        .map-address-pill {
            position: absolute;
            bottom: 52vh;
            /* Just above panel */
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            font-size: 11px;
            font-weight: 600;
            color: var(--navy-dark);
            z-index: 900;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid #e2e8f0;
            transition: bottom 0.3s;
            /* Smooth transition if panel moves */
        }

        .map-address-pill i {
            color: var(--gold);
            font-size: 14px;
        }

        /* PAINEL INFERIOR */
        .bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: auto;
            background: white;
            z-index: 1000;
            border-radius: 24px 24px 0 0;
            padding: 16px 20px;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.1);
            height: 50vh;
            /* Fixed 50% */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* NO SCROLL */
        }

        /* HEADER DO PAINEL */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .car-info h2 {
            font-size: 20px;
            margin: 0;
            color: var(--navy-dark);
            line-height: 1.2;
        }

        .car-info p {
            font-size: 14px;
            color: var(--text-gray);
            margin: 0;
        }

        .header-end {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .odometer-badge {
            font-size: 11px;
            font-weight: 600;
            color: var(--navy-dark);
            background: #f1f5f9;
            padding: 4px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #e2e8f0;
        }

        /* GRID PREMIUM - 3 COLUNAS (2 LINHAS) */
        .info-premium-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 2px;
            flex-shrink: 0;
        }

        .data-card {
            background: white;
            border-radius: 12px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            text-align: center;
            border: 1px solid #f1f5f9;
            box-shadow: 0 2px 5px rgba(148, 163, 184, 0.1);
            height: 60px;
            /* Mais compacto */
        }

        .data-icon {
            font-size: 18px;
            color: var(--navy-light);
            margin-bottom: 0;
        }

        .data-val {
            font-size: 12px;
            font-weight: 700;
            color: var(--navy-dark);
            line-height: 1.1;
        }

        .data-label {
            font-size: 8px;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 600;
        }

        .connection-status {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .signal-bars {
            display: flex;
            gap: 2px;
            align-items: flex-end;
            height: 10px;
            margin-bottom: 2px;
        }

        .bar {
            width: 3px;
            background: #cbd5e1;
            border-radius: 4px;
        }

        .bar.active {
            background: var(--success);
        }

        /* BOT√ïES DE COMANDO - VIS√çVEIS E ORGANIZADOS */
        .command-row {
            display: none;
            /* JS toggles to flex */
            gap: 8px;
            margin-top: auto;
            /* Empurra para baixo */
            padding-top: 2px;
            flex-shrink: 0;
            width: 100%;
        }

        .btn-cmd {
            flex: 1;
            padding: 0;
            /* Let height control */
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: white;
            min-height: 40px;
            /* Compact height */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-cmd i {
            font-size: 18px;
            margin: 0;
        }

        .btn-cmd:active {
            opacity: 0.9;
            transform: scale(0.98);
        }

        .car-info {
            max-width: 60%;
        }

        .car-info h2 {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            font-size: 18px;
            color: var(--navy-dark);
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .car-info p {
            margin: 0;
            font-size: 12px;
            color: var(--gray);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .st-moving {
            background: #dcfce7;
            color: #166534;
        }

        .st-stopped {
            background: #fef3c7;
            color: #b45309;
        }

        .st-offline {
            background: #f1f5f9;
            color: #64748b;
        }

        .cmd-block {
            background: var(--danger);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .cmd-unblock {
            background: var(--success);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* PAINEL DE HIST√ìRICO (BOTTOM SHEET) */
        .history-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 2000;
            border-radius: 24px 24px 0 0;
            padding: 0;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.2);
            height: 60vh;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex;
            flex-direction: column;
        }

        .history-panel.active {
            transform: translateY(0);
        }

        .history-header {
            padding: 16px 20px;
            background: white;
            /* Header branco limpo ou navy */
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 24px 24px 0 0;
        }

        .history-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            background: #f8fafc;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }

        .btn-drawer {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .btn-search {
            background: var(--navy-dark);
            color: var(--white);
        }

        .btn-pdf {
            background: var(--white);
            color: var(--navy-dark);
            border: 1px solid var(--navy-dark);
        }

        :root {
            --gold: #d4af37;
        }

        /* Hist Stats Style */
        #histStats strong {
            font-family: 'Poppins', sans-serif;
            letter-spacing: -0.5px;
        }

        #histList>div:active {
            transform: scale(0.98);
            background: #f1f5f9;
        }

        /* Quick Date Chips */
        .chip-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
            margin-top: 10px;
        }

        .chip-date {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .chip-date.active {
            background: var(--navy-dark);
            color: var(--gold);
            border-color: var(--navy-dark);
            box-shadow: 0 4px 6px rgba(15, 23, 42, 0.2);
        }

        /* Timeline Style */
        .timeline-item {
            position: relative;
            padding-left: 24px;
            margin-bottom: 0;
            cursor: pointer;
            padding-bottom: 16px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 6px;
            bottom: -6px;
            width: 2px;
            background: #e2e8f0;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 4px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--navy-dark);
            z-index: 1;
        }

        .timeline-dot.stop {
            border-color: var(--danger);
            background: var(--danger);
        }

        /* LOADING */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        /* MARKER DO MAPA */
        .custom-marker {
            width: 44px;
            height: 44px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .bg-moving {
            background: var(--success);
        }

        .bg-stopped {
            background: var(--warning);
        }

        .bg-offline {
            background: var(--gray);
        }

        .pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid var(--success);
            opacity: 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* PANEL CERCA VISUAL */
        .geo-panel {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 320px;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            text-align: center;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 20px);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .geo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 700;
            color: var(--navy-dark);
        }

        .geo-radius-display {
            font-size: 14px;
            background: #e2e8f0;
            padding: 4px 10px;
            border-radius: 10px;
            color: var(--navy-dark);
        }

        .geo-slider-container {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .geo-slider {
            flex: 1;
            accent-color: var(--blue-bright);
            height: 6px;
            cursor: pointer;
        }

        .geo-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-geo-cancel {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            background: #f8fafc;
            color: #475569;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-geo-save {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: var(--blue-bright);
            color: white;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
    </style>
</head>

<body>

    <div id="loading" class="loading-overlay">
        <i class="ph ph-spinner-gap ph-spin" style="font-size: 40px; color: var(--navy-dark);"></i>
        <p style="margin-top: 15px; font-weight: 600; color: #64748b;">Conectando...</p>
    </div>

    <div id="toast"
        style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; font-size: 12px; z-index: 5000; display: none; white-space: nowrap; max-width: 90%;">
    </div>

    <div class="top-bar">
        <button class="btn-back" onclick="window.location.href='home.html'">
            <i class="ph ph-caret-left"></i>
        </button>
        <div class="action-group">
            <button class="btn-action" onclick="toggleHistory()" title="Hist√≥rico e Relat√≥rios">
                <i class="ph-bold ph-clock-counter-clockwise"></i>
            </button>
        </div>
    </div>

    <div id="map"></div>
    <div id="uiAddressPill" class="map-address-pill">
        <i class="ph-fill ph-spinner ph-spin" style="color:var(--navy-dark)"></i> Buscando...
    </div>

    <div class="bottom-panel">
        <div class="panel-header">
            <div class="car-info">
                <h2 id="uiModel">Carregando...</h2>
                <p id="uiPlate">...</p>
            </div>
            <div class="header-end">
                <div class="odometer-badge">
                    <i class="ph-bold ph-road-horizon" style="color:var(--navy-light)"></i>
                    <span id="uiOdometer">0 km</span>
                </div>
                <div id="uiBadge" class="status-badge st-offline">
                    <i class="ph-fill ph-wifi-slash"></i> Conectando
                </div>
            </div>
        </div>

        <div class="info-premium-grid">
            <!-- Ignition Status -->
            <div class="data-card">
                <i class="ph-bold ph-key data-icon" id="iconIgnition" style="color:var(--gray)"></i>
                <span class="data-val" id="uiIgnition">---</span>
                <span class="data-label">Igni√ß√£o</span>
            </div>
            <!-- Speed -->
            <div class="data-card">
                <i class="ph-bold ph-speedometer data-icon"></i>
                <span class="data-val" id="uiSpeed">0 km/h</span>
                <span class="data-label">Velocidade</span>
            </div>
            <!-- Battery -->
            <div class="data-card">
                <i class="ph-bold ph-battery-high data-icon" style="color:#10b981;"></i>
                <span class="data-val" id="uiBattery">Ok</span>
                <span class="data-label">Bateria</span>
            </div>
            <!-- Sats -->
            <div class="data-card">
                <i class="ph-bold ph-broadcast data-icon"></i>
                <span class="data-val" id="uiSats">---</span>
                <span class="data-label">Sat√©lites</span>
            </div>
            <!-- Connection -->
            <div class="data-card">
                <div class="signal-bars">
                    <div class="bar active"></div>
                    <div class="bar active"></div>
                    <div class="bar active"></div>
                    <div class="bar"></div>
                </div>
                <span class="data-val" id="uiSignalStatus" style="font-size:11px; margin-top:4px;">Online</span>
                <span class="data-label">Conex√£o</span>
            </div>
            <!-- Lock Status -->
            <div class="data-card">
                <i class="ph-bold ph-lock-key-open data-icon" id="uiLockIcon" style="color:var(--success)"></i>
                <span class="data-val" id="uiLockStatus">Lib.</span>
                <span class="data-label">Bloqueio</span>
            </div>
        </div>

        <div
            style="display: flex; justify-content: space-between; align-items: center; padding: 0 4px 12px 4px; font-size:11px; color:#94a3b8;">
            <span id="uiLastUpdate">Atualizado: --:--</span>
            <span id="uiCourse" style="display:flex; align-items:center; gap:4px;"><i class="ph-bold ph-compass"></i>
                --</span>
        </div>

        <div id="commandSection" class="command-row">
            <button class="btn-cmd cmd-block" onclick="confirmCommand('block')">
                <i class="ph-bold ph-lock-key"></i> BLOQUEAR
            </button>
            <button class="btn-cmd cmd-unblock" onclick="confirmCommand('unblock')">
                <i class="ph-bold ph-lock-key-open"></i> DESBLOQUEAR
            </button>
            <button id="btnGeofence" class="btn-cmd"
                style="background:var(--blue-bright); box-shadow: 0 4px 12px rgba(37,99,235,0.3);"
                onclick="toggleGeofence()">
                <i class="ph-bold ph-hexagon"></i> CERCA
            </button>
        </div>
    </div>

    <div id="historyPanel" class="history-panel">
        <div class="history-header">
            <span style="font-weight: 700; color: var(--navy-dark);"><i class="ph-bold ph-calendar"></i> Hist√≥rico de
                Movimento</span>
            <i class="ph-bold ph-x" onclick="toggleHistory()"
                style="cursor: pointer; font-size: 20px; color: var(--gray);"></i>
        </div>
        <div class="history-body">
            <!-- Quick Chips -->
            <div class="chip-group">
                <button class="chip-date active" onclick="setHistoryDate('today', this)">Hoje</button>
                <button class="chip-date" onclick="setHistoryDate('yesterday', this)">Ontem</button>
                <button class="chip-date" onclick="setHistoryDate('last6h', this)">√öltimas 6h</button>
                <button class="chip-date" onclick="toggleCustomDate(this)">Personalizado</button>
            </div>

            <div id="customDateGroup" class="date-input-group"
                style="display:none; background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:12px;">
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="margin-bottom:0; flex:1;">
                        <label
                            style="font-size:10px; font-weight:700; color:var(--gray); display:block; margin-bottom:4px;">IN√çCIO</label>
                        <input type="datetime-local" id="histStart"
                            style="width:100%; padding:8px; border-radius:8px; border:1px solid #cbd5e1; font-family:'Inter'; font-size:12px;">
                    </div>
                    <div class="form-group" style="margin-bottom:0; flex:1;">
                        <label
                            style="font-size:10px; font-weight:700; color:var(--gray); display:block; margin-bottom:4px;">FINAL</label>
                        <input type="datetime-local" id="histEnd"
                            style="width:100%; padding:8px; border-radius:8px; border:1px solid #cbd5e1; font-family:'Inter'; font-size:12px;">
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:8px; margin-bottom:15px;">
                <button class="btn-drawer btn-search" onclick="fetchHistory()"
                    style="flex:2; background:var(--navy-dark); color:var(--gold); border:none; padding:12px; border-radius:12px; font-weight:700; font-size:13px; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;">
                    <i class="ph-bold ph-magnifying-glass"></i> BUSCAR ROTA
                </button>
                <button onclick="clearHistory()"
                    style="flex:1; background:#f1f5f9; color:#64748b; border:none; border-radius:12px; font-weight:600; font-size:12px; cursor:pointer;">Limpar</button>
            </div>

            <div id="historyLoading" style="display:none; text-align:center; padding:10px;">
                <p style="font-size:12px; color:var(--text-gray);">Buscando trajetos...</p>
            </div>

            <div id="histStats"
                style="display:none; background:white; border:1px solid #e2e8f0; border-radius:12px; padding:15px; margin-bottom:15px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px;">
                    <div style="text-align:center;">
                        <span style="font-size:9px; color:var(--gray); display:block;">KM</span>
                        <strong id="statKm" style="font-size:13px; color:var(--navy-dark);">0.0</strong>
                    </div>
                    <div style="text-align:center;">
                        <span style="font-size:9px; color:var(--gray); display:block;">V.M√ÅX</span>
                        <strong id="statMaxSpeed" style="font-size:13px; color:var(--navy-dark);">0</strong>
                    </div>
                    <div style="text-align:center;">
                        <span style="font-size:9px; color:var(--gray); display:block;">MOV</span>
                        <strong id="statMoving" style="font-size:13px; color:#166534;">0h</strong>
                    </div>
                    <div style="text-align:center;">
                        <span style="font-size:9px; color:var(--gray); display:block;">IDLE</span>
                        <strong id="statIdle" style="font-size:13px; color:#b91c1c;">0h</strong>
                    </div>
                </div>
            </div>

            <div id="reproControls"
                style="display:none; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:15px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span style="font-size:11px; font-weight:700; color:var(--navy-dark);">PLAYER</span>
                    <span id="reproTime" style="font-size:11px; color:var(--gray);">--:--</span>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="btnPlay" onclick="startReproduction()"
                        style="background:var(--navy-dark); border:none; color:white; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <i class="ph-fill ph-play" style="font-size:16px;"></i>
                    </button>
                    <button onclick="stopReproduction()"
                        style="background:#e2e8f0; border:none; color:var(--navy-dark); width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <i class="ph-fill ph-stop" style="font-size:16px;"></i>
                    </button>
                    <input type="range" id="reproSlider" style="flex:1; accent-color:var(--navy-dark);" min="0"
                        max="100" value="0" oninput="seekReproduction(this.value)">
                </div>
            </div>

            <div id="histList" style="margin-top:10px;"></div>

            <button class="btn-drawer btn-pdf" onclick="generatePDF()"
                style="width:100%; background:white; color:var(--danger); border:1px solid #fee2e2; padding:12px; border-radius:12px; font-weight:600; font-size:13px; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; margin-top:20px;">
                <i class="ph-bold ph-file-pdf"></i> PDF
            </button>
        </div>
    </div>

    <div id="geoControlPanel" class="geo-panel">
        <div class="geo-header">
            <span>Ajustar Cerca</span>
            <span id="geoRadiusVal" class="geo-radius-display">500 m</span>
        </div>
        <p style="font-size: 12px; color: var(--gray); margin-bottom: 10px;">Arraste o pino no mapa ou use a barra
            abaixo para definir o raio.</p>

        <div class="geo-slider-container">
            <span style="font-size:10px; font-weight:600; color:var(--gray)">100m</span>
            <input type="range" id="geoRadiusSlider" class="geo-slider" min="100" max="5000" step="100" value="500"
                oninput="updateGeoPreview(this.value)">
            <span style="font-size:10px; font-weight:600; color:var(--gray)">5km</span>
        </div>

        <div class="geo-actions">
            <button class="btn-geo-cancel" onclick="cancelGeofenceEdit()">Cancelar</button>
            <button class="btn-geo-save" onclick="saveGeofenceEdit()">Salvar Cerca</button>
        </div>
    </div>

    <!-- CARREGAR FIREBASE GLOBALMENTE (COMPAT MODE) -->
    <script src="js/local_firebase/firebase-app-compat.js"></script>
    <script src="js/local_firebase/firebase-auth-compat.js"></script>
    <script src="js/local_firebase/firebase-firestore-compat.js"></script>

    <script>
        // --- 1. INITIALIZATION (EXACTLY AS MAPAMENU.HTML) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB1kKppCK9a5fkNv3AatAmg-7kIWewikLg",
            authDomain: "rastreiamais-81087.firebaseapp.com",
            projectId: "rastreiamais-81087",
            storageBucket: "rastreiamais-81087.firebasestorage.app",
            messagingSenderId: "804875668297",
            appId: "1:804875668297:web:175d027f67b4faca192898",
            measurementId: "G-QML2D91DJW"
        };
        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. MAP SETUP ---
        const map = L.map('map', { zoomControl: false }).setView([-23.550520, -46.633308], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // --- 3. STATE VARIABLES ---
        let selectedVehicleId = new URLSearchParams(window.location.search).get('id');
        let currentVehicleData = null;
        let activeImei = null;
        let vehicleMarker = null;
        let activeGeofence = null;
        let isEditingGeofence = false;
        let tempGeofenceCirc = null;
        let tempGeofenceMarker = null;
        let hasCenteredMap = false;

        // Helpers
        const showToast = (msg) => {
            const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        };

        const dismissLoading = () => {
            const el = document.getElementById('loading');
            if (el) { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 500); }
        };

        // Safety Timeout for Loading
        setTimeout(() => { dismissLoading(); }, 8000);

        let homePos = null;
        let lastIgn = null;

        // --- 4. AUTH & DATA LOADING ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Fetch Home Address
                db.collection("tenants").doc("UNIK").collection("users")
                    .where("uid", "==", user.uid).get().then(snap => {
                        if (!snap.empty) {
                            const d = snap.docs[0].data();
                            if (d.homeLat && d.homeLng) {
                                homePos = { lat: d.homeLat, lng: d.homeLng };
                                renderHomeMarker(homePos);
                            }
                        }
                    });

                if (selectedVehicleId) {
                    initSingleVehicle(selectedVehicleId);
                } else {
                    window.location.href = 'mapamenu.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function initSingleVehicle(vid) {
            // Listener for Vehicle Doc (Using Compat v8)
            db.collection("tenants").doc("UNIK").collection("vehicles").doc(vid)
                .onSnapshot((docSnap) => {
                    if (!docSnap.exists) {
                        showToast("Ve√≠culo n√£o encontrado");
                        dismissLoading();
                        return;
                    }

                    const vData = docSnap.data();
                    currentVehicleData = vData;

                    updateVehicleStaticUI(vData);

                    // Setup Tracker Listener
                    if (vData.trackerId) subscribeToTracker(vData.trackerId, 'id');
                    else if (vData.imei) subscribeToTracker(vData.imei, 'imei');
                    else {
                        dismissLoading();
                        updateVehicleStatusUI(null);
                    }

                    // Check Geofence
                    if (vData.geofence) renderGeofence(vData.geofence);
                    else renderGeofence(null);

                }, (error) => {
                    console.error("Error vehicle:", error);
                    dismissLoading();
                });
        }

        function subscribeToTracker(ident, type) {
            let ref;
            if (type === 'id') {
                ref = db.collection("tenants").doc("UNIK").collection("trackers").doc(ident);
            } else {
                ref = db.collection("tenants").doc("UNIK").collection("trackers").where("imei", "==", ident);
            }

            ref.onSnapshot((snap) => {
                let tData = null;
                if (type === 'id') {
                    if (snap.exists) tData = snap.data();
                } else {
                    if (!snap.empty) tData = snap.docs[0].data();
                }

                if (tData) {
                    activeImei = tData.imei || ident;
                    updateVehicleStatusUI(tData);
                    updateMapPosition(tData);
                    checkGeofenceAlert(tData.lat, tData.lng);
                }
                dismissLoading();
            });
        }

        // --- 5. UI UPDATES ---
        function updateVehicleStaticUI(vData) {
            document.getElementById('uiModel').innerText = vData.model || "Ve√≠culo";
            document.getElementById('uiPlate').innerText = vData.plate || "---";

            // Check Blocker UI availability (assuming available if fetched)
            // Check Blocker UI availability - Only show if has blocker
            // Verifica bloqueador nas propriedades do ve√≠culo
            const hasBlocker = vData.blockerInstalled === true || vData.hasBlocker === true || vData.bloqueador === true || vData.possuiBloqueador === true;

            if (hasBlocker) {
                document.getElementById('commandSection').style.display = 'flex';
            } else {
                document.getElementById('commandSection').style.display = 'none';
            }
        }

        function updateVehicleStatusUI(tData) {
            if (!tData) return;

            // Status Logic
            const now = new Date();
            let isOnline = false;
            let lastDate = null;
            if (tData.lastSignal && tData.lastSignal.toDate) {
                lastDate = tData.lastSignal.toDate();
                if ((now - lastDate) / 60000 < 15) isOnline = true;
            }

            let status = !isOnline ? 'offline' : (tData.ignition || tData.speed > 0 ? 'moving' : 'stopped');

            // Badge
            const badge = document.getElementById('uiBadge');
            const bars = document.querySelectorAll('.bar');

            if (status === 'moving') {
                badge.className = 'status-badge st-moving'; badge.innerHTML = '<i class="ph-fill ph-navigation-arrow"></i> Em Movimento';
                document.getElementById('uiSignalStatus').innerText = 'Online';
                bars.forEach(b => b.classList.add('active'));
            } else if (status === 'stopped') {
                badge.className = 'status-badge st-stopped'; badge.innerHTML = '<i class="ph-fill ph-hand-palm"></i> Parado';
                document.getElementById('uiSignalStatus').innerText = 'Online';
                bars.forEach(b => b.classList.add('active'));
            } else {
                badge.className = 'status-badge st-offline'; badge.innerHTML = '<i class="ph-fill ph-wifi-slash"></i> Sem Sinal';
                document.getElementById('uiSignalStatus').innerText = 'Offline';
                bars.forEach(b => b.classList.remove('active'));
                if (bars.length > 0) bars[0].classList.add('active');
            }

            // Data Cards
            document.getElementById('uiSpeed').innerText = (tData.speed || 0) + ' km/h';
            document.getElementById('uiSats').innerText = tData.sats || 0;

            const isIgn = tData.ignition || (tData.speed > 3);
            const ignEl = document.getElementById('uiIgnition');
            ignEl.innerText = isIgn ? 'Ligada' : 'Deslig.';
            document.getElementById('iconIgnition').style.color = isIgn ? 'var(--success)' : 'var(--gray)';

            // Ignition Monitor for Alert
            if (lastIgn === false && isIgn === true) {
                if (window.Notification && Notification.permission === "granted") {
                    new Notification("Unik Rastreia", { body: `‚ö†Ô∏è Ve√≠culo LIGADO: ${currentVehicleData?.model || 'Seu ve√≠culo'}` });
                }
                showToast("üö® VE√çCULO LIGADO!");
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
            lastIgn = isIgn;

            const isBlocked = currentVehicleData.status === 'blocked';
            document.getElementById('uiLockStatus').innerText = isBlocked ? 'Bloq.' : 'Lib.';
            const lockIcon = document.getElementById('uiLockIcon');
            lockIcon.className = isBlocked ? 'ph-bold ph-lock-key' : 'ph-bold ph-lock-key-open';
            lockIcon.style.color = isBlocked ? 'var(--danger)' : 'var(--success)';

            // Odometer & Time
            document.getElementById('uiOdometer').innerText = Math.floor(tData.odometer || currentVehicleData.odometer || 0) + ' km';

            if (lastDate) {
                document.getElementById('uiLastUpdate').innerText = 'Atualizado: ' + lastDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            }

            // Course
            const course = tData.course || 0;
            const directions = ['N', 'NE', 'L', 'SE', 'S', 'SW', 'O', 'NW'];
            const dirIndex = Math.round(((course % 360) / 45)) % 8;
            document.getElementById('uiCourse').innerHTML = `<i class="ph-bold ph-compass" style="transform: rotate(${course}deg)"></i> ${directions[dirIndex]}`;
        }

        function updateMapPosition(tData) {
            const lat = parseFloat(tData.lat);
            const lng = parseFloat(tData.lng);

            if (!lat || !lng) return;

            let bg = 'bg-offline';
            let icon = 'ph-car-profile';
            if (tData.ignition || tData.speed > 0) bg = 'bg-moving';
            else if ((new Date() - (tData.lastSignal?.toDate ? tData.lastSignal.toDate() : new Date())) / 60000 < 15) bg = 'bg-stopped';

            const customIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="custom-marker ${bg}"><i class="ph-fill ${icon}"></i></div>`,
                iconSize: [44, 44], iconAnchor: [22, 22]
            });

            if (!vehicleMarker) {
                vehicleMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
                centerOnVehicleWithOffset(lat, lng);
            } else {
                vehicleMarker.setLatLng([lat, lng]).setIcon(customIcon);
                if (!hasCenteredMap) centerOnVehicleWithOffset(lat, lng);
                // Auto follow logic? Always center? 
                // Let's stick to initial center then user can move.
                // User wants "Follow Mode"? Usually yes for single map.
                map.panTo([lat, lng], { animate: true, duration: 1.0 }); // Smooth follow
            }

            fetchAddressDOM(lat, lng);
        }

        function centerOnVehicleWithOffset(lat, lng) {
            const mapHeight = map.getSize().y;
            const targetPoint = map.project([lat, lng], 16).add([0, mapHeight * 0.25]); // Shift down to show above panel
            const targetLatLng = map.unproject(targetPoint, 16);
            map.setView(targetLatLng, 16);
            hasCenteredMap = true;
        }

        // --- 6. COMMANDS & GEOFENCE ---
        window.confirmCommand = async (type) => {
            if (!activeImei) return showToast("IMEI n√£o identificado.");

            const msg = type === 'block' ? "ATEN√á√ÉO: Bloquear ve√≠culo desligar√° o motor. Confirmar?" : "Desbloquear ve√≠culo?";
            if (!confirm(msg)) return;

            showToast("Enviando comando...");
            try {
                // Compat v8 Add
                await db.collection("tenants").doc("UNIK").collection("commands").add({
                    imei: activeImei,
                    commandType: type,
                    status: 'pending',
                    requestTime: firebase.firestore.FieldValue.serverTimestamp(),
                    origin: 'web_app',
                    user: auth.currentUser ? auth.currentUser.email : 'anonymous'
                });
                showToast("Comando enviado!");
            } catch (e) {
                console.error(e);
                showToast("Erro ao enviar comando.");
            }
        };

        // Geofence Visuals
        function renderGeofence(geoData) {
            if (activeGeofence) {
                if (activeGeofence.layer) map.removeLayer(activeGeofence.layer);
                if (activeGeofence.marker) map.removeLayer(activeGeofence.marker);
                activeGeofence = null;
            }
            updateGeofenceButtonUI(false);

            if (!geoData || !geoData.enabled) return;

            const circle = L.circle([geoData.lat, geoData.lng], {
                color: '#2563eb', fillColor: '#3b82f6', fillOpacity: 0.15, weight: 2, radius: geoData.radius
            }).addTo(map);

            const cIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background:var(--blue-bright); width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`,
                iconSize: [12, 12], iconAnchor: [6, 6]
            });
            const marker = L.marker([geoData.lat, geoData.lng], { icon: cIcon }).addTo(map);

            activeGeofence = { lat: geoData.lat, lng: geoData.lng, radius: geoData.radius, layer: circle, marker: marker };
            updateGeofenceButtonUI(true);
        }

        function renderHomeMarker(pos) {
            const homeIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background:var(--navy-dark); width:36px; height:36px; border-radius:50%; border:3px solid var(--gold); display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); color:var(--gold); font-size:20px;"><i class="ph-fill ph-house"></i></div>`,
                iconSize: [36, 36], iconAnchor: [18, 18]
            });
            L.marker([pos.lat, pos.lng], { icon: homeIcon }).addTo(map).bindPopup("Minha Casa");
        }

        function updateGeofenceButtonUI(isActive) {
            const btn = document.getElementById('btnGeofence');
            if (isActive) {
                btn.style.background = '#ef4444';
                btn.innerHTML = '<i class="ph-bold ph-trash"></i> REMOVER';
            } else {
                btn.style.background = 'var(--blue-bright)';
                btn.innerHTML = '<i class="ph-bold ph-hexagon"></i> CERCA';
            }
        }

        window.toggleGeofence = () => {
            if (activeGeofence) {
                if (confirm("Remover cerca atual?")) removeGeofence();
            } else {
                startGeofenceEdit();
            }
        };

        function removeGeofence() {
            db.collection("tenants").doc("UNIK").collection("vehicles").doc(selectedVehicleId).update({ geofence: null })
                .then(() => showToast("Cerca removida."))
                .catch(() => showToast("Erro ao remover."));
        }

        function startGeofenceEdit() {
            if (!vehicleMarker) return showToast("Aguarde ve√≠culo carregar.");
            isEditingGeofence = true;
            document.getElementById('geoControlPanel').style.display = 'block';
            updateGeoPreview(500);
            map.setView(vehicleMarker.getLatLng(), 16);
        }

        window.cancelGeofenceEdit = () => {
            isEditingGeofence = false;
            document.getElementById('geoControlPanel').style.display = 'none';
            if (tempGeofenceCirc) map.removeLayer(tempGeofenceCirc);
            if (tempGeofenceMarker) map.removeLayer(tempGeofenceMarker);
        };

        window.updateGeoPreview = (val) => {
            const r = parseInt(val);
            document.getElementById('geoRadiusVal').innerText = r + ' m';
            const vPos = vehicleMarker.getLatLng();

            if (!tempGeofenceCirc) tempGeofenceCirc = L.circle(vPos, { color: '#2563eb', dashArray: '5,5', radius: r }).addTo(map);
            else tempGeofenceCirc.setRadius(r);

            if (!tempGeofenceMarker) {
                const dragIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background:white; color:var(--blue-bright); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); font-size:24px;"><i class="ph-fill ph-crosshair"></i></div>`,
                    iconSize: [40, 40], iconAnchor: [20, 20]
                });
                tempGeofenceMarker = L.marker(vPos, { icon: dragIcon, draggable: true, zIndexOffset: 2000 }).addTo(map);
                tempGeofenceMarker.on('drag', e => tempGeofenceCirc.setLatLng(e.target.getLatLng()));
            }
        };

        window.saveGeofenceEdit = () => {
            const center = tempGeofenceMarker.getLatLng();
            const radius = parseInt(document.getElementById('geoRadiusSlider').value);
            const geoData = { enabled: true, lat: center.lat, lng: center.lng, radius: radius };

            db.collection("tenants").doc("UNIK").collection("vehicles").doc(selectedVehicleId).update({ geofence: geoData })
                .then(() => { showToast("Cerca Salva!"); cancelGeofenceEdit(); })
                .catch(() => showToast("Erro ao salvar."));
        };

        function checkGeofenceAlert(lat, lng) {
            if (!activeGeofence) return;
            const d = L.latLng(lat, lng).distanceTo(L.latLng(activeGeofence.lat, activeGeofence.lng));
            if (d > activeGeofence.radius) {
                // Throttle alert?
                showToast("üö® VE√çCULO FORA DA CERCA!");
            }
        }

        // --- 7. EXTERNAL API UTILS ---
        function fetchAddressDOM(lat, lng) {
            const el = document.getElementById('uiAddressPill');
            el.innerHTML = '<i class="ph-fill ph-spinner ph-spin"></i> ...';
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(r => r.json())
                .then(d => {
                    let a = d.address ? (d.address.road || d.address.suburb || 'Endere√ßo') : 'Desc.';
                    if (d.address && d.address.house_number) a += `, ${d.address.house_number}`;

                    let distText = "";
                    if (homePos) {
                        const dist = calculateDistance(lat, lng, homePos.lat, homePos.lng);
                        distText = ` <span style="color:var(--gold); font-weight:bold; margin-left:8px;">(${dist.toFixed(1)} km de casa)</span>`;
                    }

                    el.innerHTML = `<i class="ph-fill ph-map-pin" style="color:var(--gold)"></i> ${a}${distText}`;
                }).catch(() => el.innerHTML = '<i class="ph-fill ph-warning"></i>');
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- 8. HISTORY LOGIC (Getrak Style) ---
        let historyPolyline = null;
        let historyMarkers = [];
        let historyData = [];

        // Set default dates
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);

        const toISO = (d) => {
            const pad = (n) => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        };

        document.getElementById('histStart').value = toISO(startOfDay);
        document.getElementById('histEnd').value = toISO(endOfDay);

        // --- QUICK DATES LOGIC ---
        window.setHistoryDate = (type, btn) => {
            // UI Toggle
            document.querySelectorAll('.chip-date').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');
            document.getElementById('customDateGroup').style.display = 'none';

            const n = new Date();
            let s, e;

            if (type === 'today') {
                s = new Date(n.getFullYear(), n.getMonth(), n.getDate(), 0, 0, 0);
                e = new Date(n.getFullYear(), n.getMonth(), n.getDate(), 23, 59, 59);
            } else if (type === 'yesterday') {
                const y = new Date(n); y.setDate(n.getDate() - 1);
                s = new Date(y.getFullYear(), y.getMonth(), y.getDate(), 0, 0, 0);
                e = new Date(y.getFullYear(), y.getMonth(), y.getDate(), 23, 59, 59);
            } else if (type === 'last6h') {
                e = new Date();
                s = new Date(e.getTime() - (6 * 60 * 60 * 1000));
            }

            document.getElementById('histStart').value = toISO(s);
            document.getElementById('histEnd').value = toISO(e);

            // Auto fetch? Optional. Let's make user click search.
            // fetchHistory(); 
        };

        window.toggleCustomDate = (btn) => {
            document.querySelectorAll('.chip-date').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');
            const grp = document.getElementById('customDateGroup');
            grp.style.display = 'block';
        };

        // Reproduction State
        let reproIndex = 0;
        let reproInterval = null;
        let reproMarker = null;

        window.toggleHistory = () => {
            const panel = document.getElementById('historyPanel');
            const vehiclePanel = document.querySelector('.bottom-panel');

            // Toggle active class
            const isActive = panel.classList.toggle('active');

            if (isActive) {
                if (vehiclePanel) vehiclePanel.style.display = 'none';
            } else {
                if (vehiclePanel) vehiclePanel.style.display = 'flex';
                clearHistory();
            }
        };

        window.clearHistory = () => {
            stopReproduction();
            if (historyPolyline) map.removeLayer(historyPolyline);
            historyMarkers.forEach(m => map.removeLayer(m));
            if (reproMarker) map.removeLayer(reproMarker);
            historyMarkers = [];
            historyData = [];
            reproMarker = null;
            document.getElementById('histStats').style.display = 'none';
            document.getElementById('reproControls').style.display = 'none';
            document.getElementById('histList').innerHTML = "";
            if (vehicleMarker && hasCenteredMap) map.setView(vehicleMarker.getLatLng(), 16);
        };

        window.fetchHistory = async () => {
            const startStr = document.getElementById('histStart').value;
            const endStr = document.getElementById('histEnd').value;

            if (!startStr || !endStr) return alert("Selecione as datas.");
            if (!activeImei) return alert("Aguarde o carregamento do ve√≠culo.");

            const start = new Date(startStr);
            const end = new Date(endStr);

            clearHistory();
            document.getElementById('historyLoading').style.display = 'block';
            document.getElementById('histList').innerHTML = "";

            try {
                const trackerId = currentVehicleData?.trackerId || activeImei;
                let snap = null;

                // Tentar diferentes subcole√ß√µes comuns
                const paths = ["locations", "history", "positions"];
                for (const path of paths) {
                    const ref = db.collection("tenants").doc("UNIK")
                        .collection("trackers").doc(trackerId)
                        .collection(path)
                        .where("timestamp", ">=", start)
                        .where("timestamp", "<=", end);

                    const s = await ref.get();
                    if (!s.empty) {
                        snap = s;
                        break;
                    }
                }

                // Fallback Global
                if (!snap || snap.empty) {
                    const gRef = db.collection("tenants").doc("UNIK").collection("history")
                        .where("imei", "==", activeImei).where("timestamp", ">=", start).where("timestamp", "<=", end);
                    const gSnap = await gRef.get();
                    if (!gSnap.empty) snap = gSnap;
                }

                if (!snap || snap.empty) {
                    document.getElementById('histList').innerHTML = '<p style="text-align:center; font-size:12px; color:#64748b; padding:10px;">Nenhum trajeto encontrado para este per√≠odo.</p>';
                    return;
                }

                historyData = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.lat && data.lng) historyData.push(data);
                });

                // Ordena√ß√£o Local (Evita erro de missing index)
                historyData.sort((a, b) => {
                    const tA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                    const tB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                    return tA - tB;
                });

                if (historyData.length === 0) {
                    document.getElementById('histList').innerHTML = '<p style="text-align:center; font-size:12px; color:#64748b; padding:10px;">Dados de localiza√ß√£o inv√°lidos.</p>';
                    return;
                }

                renderHistoryOnMap(historyData);
                calculateHistoryStats(historyData);
                initReproduction();

            } catch (err) {
                console.error("Erro hist√≥rico:", err);
                alert("Erro ao buscar dados: " + (err.message || "Erro de conex√£o"));
            } finally {
                document.getElementById('historyLoading').style.display = 'none';
            }
        };

        function renderHistoryOnMap(points) {
            const latlngs = points.map(p => [p.lat, p.lng]);

            // Draw Polyline
            historyPolyline = L.polyline(latlngs, {
                color: '#2563eb',
                weight: 4,
                opacity: 0.8,
                dashArray: '5, 10'
            }).addTo(map);

            // Bounds
            map.fitBounds(historyPolyline.getBounds(), { padding: [40, 40] });

            // Start & End Markers
            const startPoint = latlngs[0];
            const endPoint = latlngs[latlngs.length - 1];

            const startIcon = L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background:#10b981; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>',
                iconSize: [12, 12], iconAnchor: [6, 6]
            });
            const endIcon = L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background:#ef4444; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>',
                iconSize: [12, 12], iconAnchor: [6, 6]
            });

            historyMarkers.push(L.marker(startPoint, { icon: startIcon, title: "In√≠cio" }).addTo(map).bindPopup("In√≠cio do Trajeto"));
            historyMarkers.push(L.marker(endPoint, { icon: endIcon, title: "Fim" }).addTo(map).bindPopup("Fim do Trajeto"));

            // Detect Stops (Stops > 5 min)
            let stopCount = 0;
            const listEl = document.getElementById('histList');
            listEl.innerHTML = '<h5 style="font-size:11px; color:var(--gray); margin:0 0 10px 0;">EVENTOS DO TRAJETO</h5>';

            for (let i = 0; i < points.length - 1; i++) {
                const p1 = points[i];
                const p2 = points[i + 1];

                const timeDiff = (p2.timestamp.toDate() - p1.timestamp.toDate()) / 60000;

                if (timeDiff > 5) {
                    stopCount++;
                    const stopMarker = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background:var(--danger); color:white; width:22px; height:22px; border-radius:50%; border:2px solid white; font-size:10px; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.3);">P${stopCount}</div>`,
                        iconSize: [22, 22], iconAnchor: [11, 11]
                    });

                    const m = L.marker([p1.lat, p1.lng], { icon: stopMarker }).addTo(map);
                    const durationText = timeDiff > 60 ? `${Math.floor(timeDiff / 60)}h ${Math.round(timeDiff % 60)}m` : `${Math.round(timeDiff)}m`;
                    const startTime = p1.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    m.bindPopup(`<b>Parada ${stopCount}</b><br>Dura√ß√£o: ${durationText}<br>In√≠cio: ${startTime}`);
                    historyMarkers.push(m);

                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    item.onclick = () => {
                        map.setView([p1.lat, p1.lng], 17);
                        m.openPopup();
                    };

                    item.innerHTML = `
                        <div class="timeline-dot stop"></div>
                        <div style="background:white; padding:12px; border-radius:12px; border:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                            <div>
                                <span style="font-size:10px; font-weight:700; color:var(--danger); text-transform:uppercase; letter-spacing:0.5px;">PARADA #${stopCount}</span>
                                <div style="font-size:13px; font-weight:600; color:var(--navy-dark); margin-top:2px;">${startTime}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:12px; font-weight:600; color:var(--gray);"><i class="ph-bold ph-hourglass"></i> ${durationText}</div>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(item);
                }
            }
        }

        function calculateHistoryStats(points) {
            let totalDist = 0; let maxSpeed = 0; let movingTime = 0; let idleTime = 0;
            for (let i = 0; i < points.length - 1; i++) {
                const p1 = points[i]; const p2 = points[i + 1];
                const d = calculateDistance(p1.lat, p1.lng, p2.lat, p2.lng);
                totalDist += d;
                if (p1.speed > maxSpeed) maxSpeed = p1.speed;
                const dt = p2.timestamp.toDate() - p1.timestamp.toDate();
                if (p1.speed > 3) movingTime += dt; else idleTime += dt;
            }
            document.getElementById('statKm').innerText = totalDist.toFixed(1) + " km";
            document.getElementById('statMaxSpeed').innerText = Math.round(maxSpeed) + " km/h";
            const toHours = (ms) => { const h = Math.floor(ms / 3600000); const m = Math.floor((ms % 3600000) / 60000); return `${h}h ${m}m`; };
            document.getElementById('statMoving').innerText = toHours(movingTime);
            document.getElementById('statIdle').innerText = toHours(idleTime);
            document.getElementById('histStats').style.display = 'block';
        }

        function initReproduction() {
            reproIndex = 0;
            document.getElementById('reproControls').style.display = 'block';
            document.getElementById('reproSlider').max = historyData.length - 1;
            document.getElementById('reproSlider').value = 0;
            const first = historyData[0];
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="custom-marker bg-moving" style="transform:rotate(${first.course || 0}deg); border:2px solid #fff;"><i class="ph-fill ph-navigation-arrow"></i></div>`,
                iconSize: [32, 32], iconAnchor: [16, 16]
            });
            reproMarker = L.marker([first.lat, first.lng], { icon: icon, zIndexOffset: 2000 }).addTo(map);
        }

        window.startReproduction = () => {
            const btn = document.getElementById('btnPlay');
            if (reproInterval) {
                clearInterval(reproInterval); reproInterval = null;
                btn.innerHTML = '<i class="ph-fill ph-play" style="font-size:20px;"></i>';
            } else {
                btn.innerHTML = '<i class="ph-fill ph-pause" style="font-size:20px;"></i>';
                reproInterval = setInterval(() => {
                    if (reproIndex >= historyData.length - 1) { stopReproduction(); return; }
                    reproIndex++; updateReproUI();
                }, 300);
            }
        };

        window.stopReproduction = () => {
            if (reproInterval) clearInterval(reproInterval);
            reproInterval = null; reproIndex = 0;
            const btn = document.getElementById('btnPlay');
            if (btn) btn.innerHTML = '<i class="ph-fill ph-play" style="font-size:20px;"></i>';
            if (reproMarker && historyData.length > 0) {
                reproMarker.setLatLng([historyData[0].lat, historyData[0].lng]);
            }
            const slider = document.getElementById('reproSlider');
            if (slider) slider.value = 0;
            if (document.getElementById('reproTime')) document.getElementById('reproTime').innerText = "--:--";
        };

        window.seekReproduction = (val) => {
            reproIndex = parseInt(val);
            updateReproUI();
        };

        function updateReproUI() {
            const point = historyData[reproIndex];
            if (!point) return;
            reproMarker.setLatLng([point.lat, point.lng]);
            const iconHtml = `<div class="custom-marker bg-moving" style="transform:rotate(${(point.course || 0) - 45}deg); border:2px solid #fff;"><i class="ph-fill ph-navigation-arrow"></i></div>`;
            reproMarker.setIcon(L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [32, 32], iconAnchor: [16, 16] }));
            document.getElementById('reproSlider').value = reproIndex;
            document.getElementById('reproTime').innerText = point.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            if (!map.getBounds().contains(reproMarker.getLatLng())) { map.panTo(reproMarker.getLatLng()); }
        }

        window.generatePDF = () => {
            showToast("Relat√≥rio PDF sendo gerado...");
            setTimeout(() => showToast("O download iniciar√° em segundos..."), 2000);
        };
    </script>
</body>

</html>